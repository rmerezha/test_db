<!DOCTYPE HTML>
<html lang="uk" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Реалізація інформаційного та програмного забезпечення - Система аналізу медіа-контенту</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Титульна сторінка</a></li><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Вступ</a></li><li class="chapter-item expanded "><a href="requirements.html"><strong aria-hidden="true">2.</strong> Розроблення загальних вимог до системи</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="state-of-the-art.html"><strong aria-hidden="true">2.1.</strong> Аналіз предметної області</a></li><li class="chapter-item expanded "><a href="stakeholders-needs.html"><strong aria-hidden="true">2.2.</strong> Запити зацікавлених осіб</a></li></ol></li><li class="chapter-item expanded "><a href="use_cases.html"><strong aria-hidden="true">3.</strong> Розроблення функціональних вимог до системи</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">4.</strong> Проєктування інформаційного забезпечення</a></li><li class="chapter-item expanded "><a href="software.html" class="active"><strong aria-hidden="true">5.</strong> Реалізація інформаційного та програмного забезпечення</a></li><li class="chapter-item expanded "><a href="test.html"><strong aria-hidden="true">6.</strong> Тестування працездатності системи</a></li><li class="chapter-item expanded "><a href="conclusion.html"><strong aria-hidden="true">7.</strong> Висновки</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Система аналізу медіа-контенту</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="Реалізація-інформаційного-та-програмного-забезпечення"><a class="header" href="#Реалізація-інформаційного-та-програмного-забезпечення">Реалізація інформаційного та програмного забезпечення</a></h1>
<h2 id="sql-скрипт-для-створення-на-початкового-наповнення-бази-даних"><a class="header" href="#sql-скрипт-для-створення-на-початкового-наповнення-бази-даних">SQL-скрипт для створення на початкового наповнення бази даних</a></h2>
<pre><code class="language-sql">
CREATE SCHEMA IF NOT EXISTS db;

CREATE TABLE IF NOT EXISTS db.role (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL UNIQUE,
    description TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS db.user (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    email VARCHAR(64) NOT NULL UNIQUE,
    password VARCHAR(128) NOT NULL,
    role_id INT NOT NULL REFERENCES db.role (id) ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS db.media_content (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(128) NOT NULL,
    description TEXT NOT NULL,
    type VARCHAR(32) NOT NULL,
    file_path VARCHAR(128) NOT NULL UNIQUE,
    user_id INT NOT NULL REFERENCES db.user (id) ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS db.project (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    description TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT NOW(),
    user_id INT NOT NULL REFERENCES db.user (id) ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS db.analysis_task (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    status VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT NOW(),
    user_id INT NOT NULL REFERENCES db.user (id) ON DELETE NO ACTION,
    project_id INT NOT NULL REFERENCES db.project (id) ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS db.task_content (
    media_content_id INT NOT NULL REFERENCES db.media_content (id) ON DELETE NO ACTION,
    analysis_task_id INT NOT NULL REFERENCES db.analysis_task (id) ON DELETE NO ACTION,
    PRIMARY KEY (media_content_id, analysis_task_id)
);

CREATE TABLE IF NOT EXISTS db.report (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT NOW(),
    analysis_task_id INT NOT NULL REFERENCES db.analysis_task (id) ON DELETE NO ACTION
);

INSERT INTO db.role (name, description)
VALUES ('User Role', 'description for User Role'),
       ('Tech Expert Role', 'description for Tech Expert Role'),
       ('Media Content Analyst Role', 'description for Media Content Analyst Role');

INSERT INTO db.user (name, email, password, role_id)
VALUES
    ('Mock user1', 'test1@test.com', '$2a$12$v.HK88e3zeXbJdQptStutOTyFBitIOdSlOxIfNeOcPey/ZKjtaWPm', 1),
    ('Mock user2', 'test2@test.com', '$2a$12$6IpiXsVmylfNzPBD29YbU.bchJr9IztZpYD/A9PrwUuIn4jEFQEd2', 1),
    ('Mock user3', 'test3@test.com', '$2a$12$363l0yY4Cxy3Gj.hr7D85OJmf0qkvd.tc0VIBxn4svkLazvsbBo3S', 1),
    ('Mock user4', 'test4@test.com', '$2a$12$auMQTmDv9D7lISYaCd7ZQO3VSXUbcjQQrcxdiooQO0EJY3q2bY4hW', 1),
    ('Mock user5', 'test5@test.com', '$2a$12$nRJp1Ad6rRHfzD7l5WLKk.c7EZ/FSuADv0MsM1qYnHSE4YxcG4joO', 1);

INSERT INTO db.media_content (title, description, type, file_path, user_id)
VALUES
    ('media content 1', '...', 'jpg', 'path/to/media/content/1', 1),
    ('media content 2', '...', 'png', 'path/to/media/content/2', 2),
    ('media content 3', '...', 'pdf', 'path/to/media/content/3', 3),
    ('media content 4', '...', 'pdf', 'path/to/media/content/4', 4),
    ('media content 5', '...', 'txt', 'path/to/media/content/5', 5);

INSERT INTO db.project (name, description, user_id)
VALUES
    ('Project 1', '...', 1),
    ('Project 2', '...', 2),
    ('Project 3', '...', 3);

INSERT INTO db.analysis_task (name, status, user_id, project_id)
VALUES
    ('analysis task 1', 'pending', 1, 1),
    ('analysis task 2', 'in progress ', 2, 1),
    ('analysis task 3', 'completed', 3, 1),
    ('analysis task 4', 'paused', 1, 2),
    ('analysis task 5', 'cancelled', 1, 3);

INSERT INTO db.task_content (media_content_id, analysis_task_id)
VALUES
    (5,1),
    (2,1),
    (2,2),
    (1,2),
    (1,5);

INSERT INTO db.report (name, content, analysis_task_id)
VALUES
    ('report 1', '...', 1),
    ('report 2', '...', 2),
    ('report 3', '...', 3),
    ('report 4', '...', 4),
    ('report 5', '...', 5);


</code></pre>
<h2 id="restfull-сервіс-для-управління-даними"><a class="header" href="#restfull-сервіс-для-управління-даними">RESTfull сервіс для управління даними</a></h2>
<h3 id="user-dto"><a class="header" href="#user-dto">User DTO</a></h3>
<pre><code class="language-java">package org.rmerezha.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Builder;

@Builder
public record UserDto(int id, String name, String email, String password, @JsonProperty("role_id") int roleId) {}
</code></pre>
<h3 id="role-dto"><a class="header" href="#role-dto">Role DTO</a></h3>
<pre><code class="language-java">package org.rmerezha.dto;

import lombok.Builder;

@Builder
public record RoleDto(int id, String name, String description) {}
</code></pre>
<h3 id="user-entity"><a class="header" href="#user-entity">User entity</a></h3>
<pre><code class="language-java">package org.rmerezha.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

@Builder
@Data
@AllArgsConstructor
public class User{
    int id;
    String name; String email;
    String password;
    int roleId;
}
</code></pre>
<h3 id="role-entity"><a class="header" href="#role-entity">Role entity</a></h3>
<pre><code class="language-java">package org.rmerezha.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

@Builder
@Data
@AllArgsConstructor
public class Role{
    int id;
    String name;
    String description;
}
</code></pre>
<h3 id="mappers"><a class="header" href="#mappers">Mappers</a></h3>
<pre><code class="language-java">package org.rmerezha.mapper;

public interface Mapper&lt;D, E&gt; {

    D toDto(E entity);
    E toEntity(D dto);

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.mapper;

import org.rmerezha.dto.RoleDto;
import org.rmerezha.entity.Role;

public class RoleMapper implements Mapper&lt;RoleDto, Role&gt; {

    @Override
    public RoleDto toDto(Role role) {
        return new RoleDto(
                role.getId(),
                role.getName(),
                role.getDescription()
        );
    }

    @Override
    public Role toEntity(RoleDto roleDto) {
        return new Role(
                roleDto.id(),
                roleDto.name(),
                roleDto.description()
        );
    }
}

</code></pre>
<pre><code class="language-java">package org.rmerezha.mapper;

import org.rmerezha.dto.UserDto;
import org.rmerezha.entity.User;

public class UserMapper implements Mapper&lt;UserDto, User&gt; {

    @Override
    public UserDto toDto(User user) {
        return new UserDto(
                user.getId(),
                user.getName(),
                user.getEmail(),
                user.getPassword(),
                user.getRoleId()
        );
    }

    @Override
    public User toEntity(UserDto userDto) {
        return new User(
                userDto.id(),
                userDto.name(),
                userDto.email(),
                userDto.password(),
                userDto.roleId()
        );
    }

}
</code></pre>
<h3 id="properties-util"><a class="header" href="#properties-util">Properties Util</a></h3>
<pre><code class="language-java">import java.io.IOException;
import java.util.Properties;

public class PropertiesUtil {

    private static final Properties properties = new Properties();

    private static final String PROPERTIES_PATH = "application.properties";

    static {
        loadProperties();
    }

    private static void loadProperties() {
        var resourceAsStream = PropertiesUtil.class.getClassLoader().getResourceAsStream(PROPERTIES_PATH);
        try (resourceAsStream) {
            properties.load(resourceAsStream);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    public static String get(String key) {
        return properties.getProperty(key);
    }

}
</code></pre>
<h3 id="connection-pool-for-database"><a class="header" href="#connection-pool-for-database">Connection Pool for database</a></h3>
<pre><code class="language-java">package org.rmerezha.util;

import java.lang.reflect.Proxy;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.concurrent.ArrayBlockingQueue;

public class ConnectionPool {

    private static final String POOL_SIZE_KEY = "db.pool.size";
    private static final String URL_KEY = "db.url";
    private static final String USER_KEY = "db.user";
    private static final String PASSWD_KEY = "db.passwd";
    private static final ArrayList&lt;Connection&gt; sourceConnections = new ArrayList&lt;&gt;();

    private static ArrayBlockingQueue&lt;Connection&gt; pool;

    static {
        loadDriver();
        initPool();
    }

    private static void loadDriver() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException(e);
        }
    }

    private static void initPool() {
        int poolSize = Integer.parseInt(PropertiesUtil.get(POOL_SIZE_KEY));
        pool = new ArrayBlockingQueue&lt;&gt;(poolSize);
        for (int i = 0; i &lt; poolSize; i++) {
            var sourceConnection = createConnection();
            var proxyConnection = (Connection)
                    Proxy.newProxyInstance(ConnectionPool.class.getClassLoader(), new Class[]{Connection.class},
                            (proxy, method, args) -&gt; method.getName().equals("close")
                                    ? pool.add((Connection) proxy)
                                    : method.invoke(sourceConnection, args));
            pool.add(proxyConnection);
            sourceConnections.add(sourceConnection);
        }
    }

    private static Connection createConnection() {
        try {
            return DriverManager.getConnection(
                    PropertiesUtil.get(URL_KEY),
                    PropertiesUtil.get(USER_KEY),
                    PropertiesUtil.get(PASSWD_KEY));
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }

    }

    public static Connection get() {
        try {
            return pool.take();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }


}
</code></pre>
<h3 id="util-for-json"><a class="header" href="#util-for-json">Util for JSON</a></h3>
<pre><code class="language-java">package org.rmerezha.util;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;

import java.util.List;

public class JsonBuilder {

    private final static String STATUS_KEY = "status";
    private final static String MESSAGE_KEY = "message";
    private final static String CODE_KEY = "code";
    private final static String DATA_KEY = "data";
    private final static String ERRORS_KEY = "errors";
    private final ObjectMapper mapper = new ObjectMapper();
    private final ObjectNode rootNode = mapper.createObjectNode();
    private final ObjectNode dataNode = mapper.createObjectNode();

    public JsonBuilder() {
        mapper.registerModule(new JavaTimeModule());
    }

    public JsonBuilder setStatus(Status status) {
        rootNode.put(STATUS_KEY, status.getType());
        return this;
    }

    public JsonBuilder setData(String key, String val) {
        dataNode.put(key, val);
        return this;
    }

    public JsonBuilder setData(String key, long val) {
        dataNode.put(key, val);
        return this;
    }

    public JsonBuilder setData(String key, List&lt;?&gt; vals) {
        JsonNode listNode = mapper.valueToTree(vals);
        dataNode.set(key, listNode);
        return this;
    }

    public JsonBuilder setMessage(String message) {
        rootNode.put(MESSAGE_KEY, message);
        return this;
    }

    public JsonBuilder setErrors(List&lt;Error&gt; errors) {
        ArrayNode errorsNode = mapper.createArrayNode();
        errors.forEach(e -&gt; {
            ObjectNode error = mapper.createObjectNode();
            JsonNode errorCode = mapper.valueToTree(e.getCode());
            JsonNode errorMessage = mapper.valueToTree(e.getMessage());
            error.set(CODE_KEY, errorCode);
            error.set(MESSAGE_KEY, errorMessage);
            errorsNode.add(error);
        });
        rootNode.set(ERRORS_KEY, errorsNode);
        return this;
    }

    public String build() {
        if (!dataNode.isEmpty()) {
            rootNode.set(DATA_KEY, dataNode);
        }
        return rootNode.toString();
    }
}
</code></pre>
<pre><code class="language-java">package org.rmerezha.util;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.SneakyThrows;

import java.io.InputStream;

public class JsonParser {

    @SneakyThrows
    public &lt;T&gt; T parse(InputStream in, Class&lt;T&gt; clazz) {

        var objMapper = new ObjectMapper();

        return objMapper.readValue(in, clazz);
    }

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.util;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public enum Error {
    USER_EXIST(1, "User with this email already exists"),
    USER_NOT_FOUND(3, "User with this id does not exist"),
    ROLE_EXIST(1, "Role with this name already exists"),
    ROLE_NOT_FOUND(3, "Role with this id does not exist");

    private final int code;
    private final String message;

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.util;

import lombok.Getter;

@Getter
public enum Status {
    SUCCESS("success"),
    FAIL("fail");

    private final String type;

    Status(String type) {
        this.type = type;
    }

}
</code></pre>
<h3 id="dao-layer"><a class="header" href="#dao-layer">DAO layer</a></h3>
<pre><code class="language-java">package org.rmerezha.dao;

import java.sql.Connection;
import java.util.Optional;

public interface Dao&lt;E&gt; {

    void create(E entity, Connection connection);

    Optional&lt;E&gt; read(int id, Connection connection);

    boolean update(E entity, Connection connection);

    boolean delete(int id, Connection connection);

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.dao;

import lombok.SneakyThrows;
import org.rmerezha.entity.User;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.Optional;

public class UserDao implements Dao&lt;User&gt; {

    private final static String CREATE = """
                    INSERT INTO user (name, email, password, role_id)
                    VALUES (?, ?, ?, ?);
                    """;

    private final static String READ = """
                    SELECT id,
                           name,
                           email,
                           password,
                           role_id
                    FROM user
                    WHERE id = ?;
                    """;

    private final static String UPDATE = """
                    UPDATE user
                    SET name = ?, email = ?, password = ?, role_id = ?
                    WHERE id = ?;
                    """;

    private final static String DELETE = """
                    DELETE FROM user
                    WHERE id = ?;
                    """;

    @Override
    @SneakyThrows
    public void create(User entity, Connection connection) {
        try (var ps = connection.prepareStatement(CREATE, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, entity.getName());
            ps.setString(2, entity.getEmail());
            ps.setString(3, entity.getPassword());
            ps.setInt(4, entity.getRoleId());
            ps.executeUpdate();

            var gk = ps.getGeneratedKeys();
            if (gk.next()) {
                entity.setId(gk.getInt(1));
            }
        }
    }

    @Override
    @SneakyThrows
    public Optional&lt;User&gt; read(int id, Connection connection) {
        try (var ps = connection.prepareStatement(READ)) {
            ps.setInt(1, id);
            ResultSet rs = ps.executeQuery();
            User user = null;
            if (rs.next()) {
                user = User.builder()
                        .id(rs.getInt("id"))
                        .name(rs.getString("name"))
                        .email(rs.getString("email"))
                        .password(rs.getString("password"))
                        .roleId(rs.getInt("role_id"))
                        .build();
            }
            return Optional.ofNullable(user);
        }
    }

    @Override
    @SneakyThrows
    public boolean update(User entity, Connection connection) {
        try (var ps = connection.prepareStatement(UPDATE)) {
            ps.setString(1, entity.getName());
            ps.setString(2, entity.getEmail());
            ps.setString(3, entity.getPassword());
            ps.setInt(4, entity.getRoleId());
            ps.setInt(5, entity.getId());
            return ps.executeUpdate() != 0;
        }
    }

    @Override
    @SneakyThrows
    public boolean delete(int id, Connection connection) {
        try (var ps = connection.prepareStatement(DELETE)) {
            ps.setInt(1, id);
            return ps.executeUpdate() != 0;
        }
    }
}

</code></pre>
<pre><code class="language-java">package org.rmerezha.dao;

import lombok.SneakyThrows;
import org.rmerezha.entity.Role;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.Optional;

public class RoleDao implements Dao&lt;Role&gt; {

    private final static String CREATE = """
                    INSERT INTO role (name, description)
                    VALUES (?, ?);
                    """;

    private final static String READ = """
                    SELECT id,
                           name,
                           description
                    FROM role
                    WHERE id = ?;
                    """;

    private final static String UPDATE = """
                    UPDATE role
                    SET name = ?, description = ?
                    WHERE id = ?;
                    """;

    private final static String DELETE = """
                    DELETE FROM role
                    WHERE id = ?;
                    """;

    @Override
    @SneakyThrows
    public void create(Role entity, Connection connection) {
        try (var ps = connection.prepareStatement(CREATE, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, entity.getName());
            ps.setString(2, entity.getDescription());
            ps.executeUpdate();

            var gk = ps.getGeneratedKeys();
            if (gk.next()) {
                entity.setId(gk.getInt(1));
            }
        }
    }

    @Override
    @SneakyThrows
    public Optional&lt;Role&gt; read(int id, Connection connection) {
        try (var ps = connection.prepareStatement(READ)) {
            ps.setInt(1, id);
            ResultSet rs = ps.executeQuery();
            Role role = null;
            if (rs.next()) {
                role = Role.builder()
                        .id(rs.getInt("id"))
                        .name(rs.getString("name"))
                        .description(rs.getString("description"))
                        .build();
            }
            return Optional.ofNullable(role);
        }
    }

    @Override
    @SneakyThrows
    public boolean update(Role entity, Connection connection) {
        try (var ps = connection.prepareStatement(UPDATE)) {
            ps.setString(1, entity.getName());
            ps.setString(2, entity.getDescription());
            ps.setInt(3, entity.getId());
            return ps.executeUpdate() != 0;
        }
    }

    @Override
    @SneakyThrows
    public boolean delete(int id, Connection connection) {
        try (var ps = connection.prepareStatement(DELETE)) {
            ps.setInt(1, id);
            return ps.executeUpdate() != 0;
        }
    }
}
</code></pre>
<h3 id="repository-layer"><a class="header" href="#repository-layer">Repository layer</a></h3>
<pre><code class="language-java">package org.rmerezha.repository;

import java.util.Optional;

public interface Repository&lt;D, K&gt; {

    Optional&lt;D&gt; get(K id);

    int add(D dto);

    boolean update(D dto);

    boolean remove(K id);

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.repository;

import lombok.SneakyThrows;
import org.rmerezha.dao.UserDao;
import org.rmerezha.dto.UserDto;
import org.rmerezha.mapper.UserMapper;
import org.rmerezha.util.ConnectionPool;

import java.util.Optional;

public class UserRepository implements Repository&lt;UserDto, Integer&gt; {

    private final UserDao userDao = new UserDao();
    private final UserMapper userMapper = new UserMapper();


    @Override
    @SneakyThrows
    public Optional&lt;UserDto&gt; get(Integer id) {
        try (var con = ConnectionPool.get()) {
            return userDao.read(id, con).map(userMapper::toDto);
        }
    }

    @Override
    @SneakyThrows
    public int add(UserDto dto) {
        try (var con = ConnectionPool.get()) {
            var user = userMapper.toEntity(dto);
            userDao.create(user, con);
            return user.getId();
        }
    }

    @Override
    @SneakyThrows
    public boolean update(UserDto dto) {
        try (var con = ConnectionPool.get()) {
            return userDao.update(userMapper.toEntity(dto), con);
        }
    }

    @Override
    @SneakyThrows
    public boolean remove(Integer id) {
        try (var con = ConnectionPool.get()) {
            return userDao.delete(id, con);
        }
    }
}
</code></pre>
<pre><code class="language-java">package org.rmerezha.repository;

import lombok.SneakyThrows;
import org.rmerezha.dao.RoleDao;
import org.rmerezha.dto.RoleDto;
import org.rmerezha.mapper.RoleMapper;
import org.rmerezha.util.ConnectionPool;

import java.util.Optional;

public class RoleRepository implements Repository&lt;RoleDto, Integer&gt; {

    private final RoleDao roleDao = new RoleDao();
    private final RoleMapper roleMapper = new RoleMapper();


    @Override
    @SneakyThrows
    public Optional&lt;RoleDto&gt; get(Integer id) {
        try (var con = ConnectionPool.get()) {
            return roleDao.read(id, con).map(roleMapper::toDto);
        }
    }

    @Override
    @SneakyThrows
    public int add(RoleDto dto) {
        try (var con = ConnectionPool.get()) {
            var role = roleMapper.toEntity(dto);
            roleDao.create(role, con);
            return role.getId();
        }
    }

    @Override
    @SneakyThrows
    public boolean update(RoleDto dto) {
        try (var con = ConnectionPool.get()) {
            return roleDao.update(roleMapper.toEntity(dto), con);
        }
    }

    @Override
    @SneakyThrows
    public boolean remove(Integer id) {
        try (var con = ConnectionPool.get()) {
            return roleDao.delete(id, con);
        }
    }

}
</code></pre>
<h3 id="service-layer"><a class="header" href="#service-layer">Service layer</a></h3>
<pre><code class="language-java">package org.rmerezha.service;

import java.io.InputStream;

public interface Service {

    String get(InputStream jsonStream);

    String add(InputStream jsonStream);

    String update(InputStream jsonStream);

    String remove(InputStream jsonStream);

}
</code></pre>
<pre><code class="language-java">package org.rmerezha.service;

import org.rmerezha.dto.UserDto;
import org.rmerezha.repository.UserRepository;
import org.rmerezha.util.Error;
import org.rmerezha.util.JsonBuilder;
import org.rmerezha.util.JsonParser;
import org.rmerezha.util.Status;

import java.io.InputStream;
import java.util.List;

public class UserService implements Service {

    private final JsonParser jsonParser = new JsonParser();
    private final UserRepository userRepository = new UserRepository();


    @Override
    public String get(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var userDto = jsonParser.parse(jsonStream, UserDto.class);
        var optUser = userRepository.get(userDto.id());
        if (optUser.isPresent()) {
            var user = optUser.get();
            jsonBuilder.setStatus(Status.SUCCESS)
                    .setData("id", user.id())
                    .setData("name", user.name())
                    .setData("email", user.email())
                    .setData("password", user.password())
                    .setData("roleId", user.roleId());
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.USER_NOT_FOUND));
        }
        return jsonBuilder.build();
    }

    @Override
    public String add(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        try {
            var userDto = jsonParser.parse(jsonStream, UserDto.class);
            int id = userRepository.add(userDto);
            jsonBuilder.setStatus(Status.SUCCESS)
                    .setData("id", id);
        } catch (Exception e) {
            jsonBuilder.setStatus(Status.FAIL).setErrors(List.of(Error.USER_EXIST));
        }
        return jsonBuilder.build();
    }

    @Override
    public String update(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var userDto = jsonParser.parse(jsonStream, UserDto.class);
        boolean isUpdated = userRepository.update(userDto);
        if (isUpdated) {
            jsonBuilder.setStatus(Status.SUCCESS);
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.USER_NOT_FOUND));
        }
        return jsonBuilder.build();
    }

    @Override
    public String remove(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var userDto = jsonParser.parse(jsonStream, UserDto.class);
        boolean isRemoved = userRepository.remove(userDto.id());
        if (isRemoved) {
            jsonBuilder.setStatus(Status.SUCCESS);
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.USER_NOT_FOUND));
        }
        return jsonBuilder.build();
    }
}
</code></pre>
<pre><code class="language-java">package org.rmerezha.service;

import org.rmerezha.dto.RoleDto;
import org.rmerezha.repository.RoleRepository;
import org.rmerezha.util.Error;
import org.rmerezha.util.JsonBuilder;
import org.rmerezha.util.JsonParser;
import org.rmerezha.util.Status;

import java.io.InputStream;
import java.util.List;

public class RoleService implements Service {

    private final JsonParser jsonParser = new JsonParser();
    private final RoleRepository roleRepository = new RoleRepository();

    @Override
    public String get(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var roleDto = jsonParser.parse(jsonStream, RoleDto.class);
        var optRole = roleRepository.get(roleDto.id());
        if (optRole.isPresent()) {
            var role = optRole.get();
            jsonBuilder.setStatus(Status.SUCCESS)
                    .setData("id", role.id())
                    .setData("name", role.name())
                    .setData("description", role.description());
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.ROLE_NOT_FOUND));
        }
        return jsonBuilder.build();
    }

    @Override
    public String add(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        try {
            var roleDto = jsonParser.parse(jsonStream, RoleDto.class);
            int id = roleRepository.add(roleDto);
            jsonBuilder.setStatus(Status.SUCCESS)
                    .setData("id", id);
        } catch (Exception e) {
            jsonBuilder.setStatus(Status.FAIL).setErrors(List.of(Error.ROLE_EXIST));
        }
        return jsonBuilder.build();
    }

    @Override
    public String update(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var roleDto = jsonParser.parse(jsonStream, RoleDto.class);
        boolean isUpdated = roleRepository.update(roleDto);
        if (isUpdated) {
            jsonBuilder.setStatus(Status.SUCCESS);
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.ROLE_NOT_FOUND));
        }
        return jsonBuilder.build();
    }

    @Override
    public String remove(InputStream jsonStream) {
        JsonBuilder jsonBuilder = new JsonBuilder();
        var roleDto = jsonParser.parse(jsonStream, RoleDto.class);
        boolean isRemoved = roleRepository.remove(roleDto.id());
        if (isRemoved) {
            jsonBuilder.setStatus(Status.SUCCESS);
        } else {
            jsonBuilder.setStatus(Status.FAIL)
                    .setErrors(List.of(Error.ROLE_NOT_FOUND));
        }
        return jsonBuilder.build();
    }
}
</code></pre>
<h3 id="servlet-layer"><a class="header" href="#servlet-layer">Servlet layer</a></h3>
<pre><code class="language-java">package org.rmerezha.servlet;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.rmerezha.service.UserService;

import java.io.IOException;

@WebServlet("/user")
public class UserServlet extends HttpServlet {

    private static final UserService USER_SERVICE = new UserService();


    @Override
    protected void doPut(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = USER_SERVICE.update(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doDelete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = USER_SERVICE.remove(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = USER_SERVICE.add(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = USER_SERVICE.get(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }
}
</code></pre>
<pre><code class="language-java">package org.rmerezha.servlet;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.rmerezha.service.RoleService;

import java.io.IOException;

@WebServlet("/role")
public class RoleServlet extends HttpServlet {

    private static final RoleService ROLE_SERVICE = new RoleService();


    @Override
    protected void doPut(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = ROLE_SERVICE.update(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doDelete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = ROLE_SERVICE.remove(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = ROLE_SERVICE.add(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        var json = ROLE_SERVICE.get(req.getInputStream());
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        resp.getWriter().write(json);
    }
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="design.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="test.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="design.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="test.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
